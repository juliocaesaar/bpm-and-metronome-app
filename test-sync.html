<!DOCTYPE html>
<html>
<head>
    <title>Teste de SincronizaÃ§Ã£o - BPM Metronome</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fafafa;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #10b981; color: white; }
        .error { background: #ef4444; color: white; }
        .warning { background: #f59e0b; color: black; }
        .info { background: #3b82f6; color: white; }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #7c3aed; }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Teste de SincronizaÃ§Ã£o - BPM Metronome</h1>
    
    <div class="test-section">
        <h2>ğŸ“¡ Status da ConexÃ£o</h2>
        <div id="connection-status" class="status info">Desconectado</div>
        <button onclick="testConnection()">Testar ConexÃ£o</button>
        <button onclick="clearLog()">Limpar Log</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ¯ Teste de SessÃ£o</h2>
        <div id="session-status" class="status info">Nenhuma sessÃ£o ativa</div>
        <button onclick="createTestSession()">Criar SessÃ£o de Teste</button>
        <button onclick="joinTestSession()">Entrar em SessÃ£o de Teste</button>
        <button onclick="leaveSession()">Sair da SessÃ£o</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸµ Teste de Ãudio</h2>
        <div id="audio-status" class="status info">Ãudio nÃ£o testado</div>
        <button onclick="testAudio()">Testar Ãudio</button>
        <button onclick="testMetronome()">Testar MetrÃ´nomo</button>
        <button onclick="testAmbient()">Testar Pad Ambiental</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š Log de Eventos</h2>
        <div id="event-log" class="log">Aguardando eventos...\n</div>
    </div>
    
    <script>
        let ws = null;
        let sessionId = null;
        let clientId = null;
        let isHost = false;
        let isInSession = false;
        
        function log(message) {
            const logElement = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('event-log').textContent = 'Log limpo...\n';
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }
        
        function testConnection() {
            log('Testando conexÃ£o com servidor...');
            updateStatus('connection-status', 'Conectando...', 'warning');
            
            try {
                ws = new WebSocket('ws://localhost:3000');
                
                ws.onopen = function() {
                    log('âœ… Conectado ao servidor WebSocket');
                    updateStatus('connection-status', 'Conectado', 'success');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ğŸ“¨ Mensagem recebida: ${data.type}`);
                        handleMessage(data);
                    } catch (error) {
                        log(`âŒ Erro ao processar mensagem: ${error.message}`);
                    }
                };
                
                ws.onclose = function() {
                    log('ğŸ”Œ ConexÃ£o fechada');
                    updateStatus('connection-status', 'Desconectado', 'error');
                };
                
                ws.onerror = function(error) {
                    log(`âŒ Erro na conexÃ£o: ${error}`);
                    updateStatus('connection-status', 'Erro de conexÃ£o', 'error');
                };
                
            } catch (error) {
                log(`âŒ Erro ao conectar: ${error.message}`);
                updateStatus('connection-status', 'Erro de conexÃ£o', 'error');
            }
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'session_created':
                    sessionId = data.sessionId;
                    clientId = data.clientId;
                    isHost = data.isHost;
                    isInSession = true;
                    log(`âœ… SessÃ£o criada: ${sessionId}`);
                    updateStatus('session-status', `Host da sessÃ£o: ${sessionId}`, 'success');
                    break;
                    
                case 'session_joined':
                    sessionId = data.sessionId;
                    clientId = data.clientId;
                    isHost = data.isHost;
                    isInSession = true;
                    log(`âœ… Entrou na sessÃ£o: ${sessionId}`);
                    updateStatus('session-status', `Participante da sessÃ£o: ${sessionId}`, 'success');
                    break;
                    
                case 'state_update':
                    log(`ğŸ”„ Estado atualizado: ${JSON.stringify(data.state)}`);
                    break;
                    
                case 'client_joined':
                    log(`ğŸ‘¤ Cliente entrou: ${data.client.name}`);
                    break;
                    
                case 'client_left':
                    log(`ğŸ‘‹ Cliente saiu: ${data.clientName}`);
                    break;
                    
                case 'error':
                    log(`âŒ Erro: ${data.message}`);
                    break;
                    
                default:
                    log(`â“ Mensagem desconhecida: ${data.type}`);
            }
        }
        
        function createTestSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ NÃ£o conectado ao servidor');
                return;
            }
            
            log('ğŸ¯ Criando sessÃ£o de teste...');
            ws.send(JSON.stringify({
                type: 'create_session',
                hostName: 'Teste Host'
            }));
        }
        
        function joinTestSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ NÃ£o conectado ao servidor');
                return;
            }
            
            const testSessionId = prompt('Digite o cÃ³digo da sessÃ£o:');
            if (!testSessionId) return;
            
            log(`ğŸ”— Entrando na sessÃ£o: ${testSessionId}`);
            ws.send(JSON.stringify({
                type: 'join_session',
                sessionId: testSessionId,
                clientName: 'Teste Cliente'
            }));
        }
        
        function leaveSession() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !isInSession) {
                log('âŒ NÃ£o hÃ¡ sessÃ£o ativa');
                return;
            }
            
            log('ğŸšª Saindo da sessÃ£o...');
            ws.send(JSON.stringify({
                type: 'leave_session'
            }));
            
            sessionId = null;
            clientId = null;
            isHost = false;
            isInSession = false;
            updateStatus('session-status', 'Nenhuma sessÃ£o ativa', 'info');
        }
        
        function testAudio() {
            log('ğŸµ Testando Ã¡udio...');
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
                
                log('âœ… Teste de Ã¡udio concluÃ­do');
                updateStatus('audio-status', 'Ãudio funcionando', 'success');
            } catch (error) {
                log(`âŒ Erro no teste de Ã¡udio: ${error.message}`);
                updateStatus('audio-status', 'Erro no Ã¡udio', 'error');
            }
        }
        
        function testMetronome() {
            if (!isInSession) {
                log('âŒ NÃ£o hÃ¡ sessÃ£o ativa para testar metrÃ´nomo');
                return;
            }
            
            log('ğŸ¥ Testando sincronizaÃ§Ã£o do metrÃ´nomo...');
            ws.send(JSON.stringify({
                type: 'state_update',
                state: { isPlaying: true }
            }));
            
            setTimeout(() => {
                ws.send(JSON.stringify({
                    type: 'state_update',
                    state: { isPlaying: false }
                }));
                log('âœ… Teste de metrÃ´nomo concluÃ­do');
            }, 2000);
        }
        
        function testAmbient() {
            if (!isInSession) {
                log('âŒ NÃ£o hÃ¡ sessÃ£o ativa para testar pad ambiental');
                return;
            }
            
            log('ğŸ¹ Testando sincronizaÃ§Ã£o do pad ambiental...');
            ws.send(JSON.stringify({
                type: 'state_update',
                state: { currentAmbientKey: 'C' }
            }));
            
            setTimeout(() => {
                ws.send(JSON.stringify({
                    type: 'state_update',
                    state: { currentAmbientKey: null }
                }));
                log('âœ… Teste de pad ambiental concluÃ­do');
            }, 2000);
        }
        
        // Inicializar teste automÃ¡tico
        window.addEventListener('load', function() {
            log('ğŸš€ PÃ¡gina de teste carregada');
            log('ğŸ’¡ Clique em "Testar ConexÃ£o" para comeÃ§ar');
        });
    </script>
</body>
</html>
